{{- $.Scratch.Add "index" slice -}}

{{- range where .Site.RegularPages "Section" "=" "articles" -}}
    
    {{- $img := (.Resources.ByType "image").GetMatch "featured*" -}}
    {{- with $img -}}
      {{- $resize := .Fill "320x480" -}}
        {{ $.Scratch.Set "image" $resize.Permalink }}
    {{- end -}}

    {{- $.Scratch.Set "hasComments" 0 -}}

    {{- $postSlug := .File.ContentBaseName -}}
    {{- $comments := index $.Site.Data.comments $postSlug -}}
  
    {{- range $comments -}}
      {{- $.Scratch.Add "hasComments" 1 -}}
    {{- end -}}
  
    {{ $hasCommentsCount := $.Scratch.Get "hasComments" }}

    {{- $.Scratch.Add "index" (dict "title" .Title "tags" .Params.tags "image" ($.Scratch.Get "image") "content" .Summary "commentsCount" $hasCommentsCount "permalink" .Permalink) -}}
{{- end -}}
{{- $.Scratch.Get "index" | jsonify -}}